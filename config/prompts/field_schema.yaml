# 核心字段校验 Schema (Step 2)
# 定义数据输入格式和校验规则

schema_version: "2.0"

# =============================================================================
# 顶层结构
# =============================================================================
root_schema:
  type: object
  required:
    - symbol
    - timestamp
    - spot
    - status
    - core_fields
  properties:
    symbol:
      type: string
      description: 标的代码
      pattern: "^[A-Z]{1,5}$"
    
    timestamp:
      type: string
      description: 数据时间戳 (ET)
      format: datetime
      example: "2025-01-03 10:30:00"
    
    spot:
      type: number
      description: 现价
      minimum: 0.01
    
    status:
      type: string
      enum:
        - data_ready
        - missing_critical
        - missing_high
        - missing_optional
      description: 数据状态
    
    data_quality:
      type: number
      description: 数据质量分数 (0-100)
      minimum: 0
      maximum: 100
    
    missing_fields:
      type: array
      items:
        type: string
      description: 缺失字段列表
    
    next_step:
      type: string
      description: 建议下一步操作

# =============================================================================
# 核心字段分组定义
# =============================================================================
core_fields:
  
  # ---------------------------------------------------------------------------
  # Gamma Regime 分组
  # ---------------------------------------------------------------------------
  gamma_regime:
    description: Gamma 环境判断字段
    fields:
      vol_trigger:
        type: number
        required: true
        priority: critical
        description: VOL TRIGGER / GEX Flip 价格
        source: "!trigger {symbol}"
        validation:
          min: 0.01
          relative_to_spot:
            min_pct: -20
            max_pct: 20
      
      spot_vs_trigger:
        type: string
        required: false
        priority: optional
        enum:
          - above
          - below
          - near
        description: 现价相对 VOL TRIGGER 位置
        derived: true
        formula: |
          if spot >= vol_trigger * 1.002: "above"
          elif spot <= vol_trigger * 0.998: "below"
          else: "near"
      
      net_gex_sign:
        type: string
        required: true
        priority: critical
        enum:
          - positive
          - negative
          - neutral
        description: NET-GEX 符号
        derived: true
        formula: |
          if spot > vol_trigger: "positive"
          elif spot < vol_trigger: "negative"
          else: "neutral"
      
      net_dex_sign:
        type: string
        required: false
        priority: optional
        enum:
          - positive
          - negative
          - neutral
          - bullish
          - bearish
        description: NET-DEX 方向
        source: "!dex {symbol}"
      
      total_net_gex:
        type: number
        required: false
        priority: optional
        description: Total NET GEX 数值
        source: "!gexn {symbol}"
        unit: dollars

  # ---------------------------------------------------------------------------
  # Key Levels 分组
  # ---------------------------------------------------------------------------
  key_levels:
    description: 关键价位字段
    fields:
      gamma_wall:
        type: number
        required: true
        priority: critical
        description: 主 Gamma Wall 位置
        source: "!gexr {symbol}"
        validation:
          relative_to_spot:
            min_pct: -15
            max_pct: 15
      
      gamma_wall_2:
        type: number
        required: false
        priority: optional
        description: 次 Gamma Wall 位置
        source: "!gexr {symbol}"
      
      call_wall:
        type: number
        required: true
        priority: high
        description: Call Wall 位置
        source: "!gexr {symbol}"
        validation:
          must_be_above: spot
      
      put_wall:
        type: number
        required: true
        priority: high
        description: Put Wall 位置
        source: "!gexr {symbol}"
        validation:
          must_be_below: spot
      
      gamma_wall_prox:
        type: number
        required: false
        priority: optional
        description: Gamma Wall 接近度 (%)
        derived: true
        formula: "abs(spot - gamma_wall) / spot * 100"
        unit: percent
      
      max_pain:
        type: number
        required: false
        priority: optional
        description: Max Pain 价格
        source: "!gexr {symbol}"
      
      major_oi_strikes:
        type: array
        items:
          type: number
        required: false
        priority: optional
        description: 主要 OI 聚集行权价列表
        source: "!oi {symbol}"

  # ---------------------------------------------------------------------------
  # IV/HV 分组
  # ---------------------------------------------------------------------------
  iv_hv:
    description: 隐含/历史波动率字段
    fields:
      iv_atm:
        type: number
        required: true
        priority: critical
        description: 当前 ATM IV (%)
        source: "!surface {symbol} ivmid"
        unit: percent
        validation:
          min: 1
          max: 300
      
      iv_front:
        type: number
        required: true
        priority: high
        description: 近月 IV (%)
        source: "!surface {symbol} ivmid"
        unit: percent
        validation:
          min: 1
          max: 300
      
      iv_back:
        type: number
        required: true
        priority: high
        description: 远月 IV (%)
        source: "!surface {symbol} ivmid"
        unit: percent
        validation:
          min: 1
          max: 300
      
      iv_event_w:
        type: number
        required: false
        priority: optional
        description: 事件周 ATM IV (%)
        source: "!surface {symbol} ivmid"
        unit: percent
        condition: "仅在事件窗口期适用"
      
      hv10:
        type: number
        required: true
        priority: high
        description: 10日历史波动率 (%)
        source: "TradingView / 计算"
        unit: percent
        validation:
          min: 1
          max: 300
      
      hv20:
        type: number
        required: true
        priority: critical
        description: 20日历史波动率 (%)
        source: "TradingView / 计算"
        unit: percent
        validation:
          min: 1
          max: 300
      
      hv60:
        type: number
        required: true
        priority: high
        description: 60日历史波动率 (%)
        source: "TradingView / 计算"
        unit: percent
        validation:
          min: 1
          max: 300

  # ---------------------------------------------------------------------------
  # Structure 分组
  # ---------------------------------------------------------------------------
  structure:
    description: 期权结构指标字段
    fields:
      vex_net:
        type: number
        required: true
        priority: high
        description: VEX 净值
        source: "!vexn {symbol}"
      
      vanna_atm:
        type: number
        required: false
        priority: optional
        description: Vanna ATM 值
        source: "!vanna {symbol}"
      
      term_slope:
        type: number
        required: false
        priority: optional
        description: 期限结构斜率
        derived: true
        formula: "iv_front - iv_back"
        unit: percent
      
      term_structure_type:
        type: string
        required: false
        priority: optional
        enum:
          - contango
          - backwardation
          - flat
        description: 期限结构类型
        derived: true
        formula: |
          if term_slope > 2: "backwardation"
          elif term_slope < -2: "contango"
          else: "flat"
      
      put_skew_25:
        type: number
        required: false
        priority: optional
        description: 25Δ Put Skew
        source: "!skew {symbol} ivmid atm 30"
        unit: percent
      
      call_skew_25:
        type: number
        required: false
        priority: optional
        description: 25Δ Call Skew
        source: "!skew {symbol} ivmid atm 30"
        unit: percent
      
      skew_asym:
        type: number
        required: false
        priority: optional
        description: Skew 不对称性 (Put - |Call|)
        derived: true
        formula: "put_skew_25 - abs(call_skew_25)"
        interpretation: "正值表示左偏（Put 保护需求高）"
      
      spread_atm:
        type: number
        required: false
        priority: optional
        description: ATM Bid-Ask Spread (%)
        source: "!surface {symbol} spread atm"
        unit: percent
        validation:
          min: 0
          max: 50
      
      pcr_ratio:
        type: number
        required: false
        priority: optional
        description: Put/Call Ratio
        source: "!pcr {symbol}"
        validation:
          min: 0.1
          max: 10
      
      smile_curvature:
        type: number
        required: false
        priority: optional
        description: 微笑曲率
        source: "计算: (25D_Put + 25D_Call - 2*ATM) / ATM"

# =============================================================================
# 字段优先级定义
# =============================================================================
priority_levels:
  critical:
    description: 缺失则无法继续分析
    fields:
      - spot
      - vol_trigger
      - gamma_wall
      - iv_atm
      - hv20
    on_missing: status = "missing_critical"
  
  high:
    description: 缺失会显著影响分析质量
    fields:
      - call_wall
      - put_wall
      - iv_front
      - iv_back
      - vex_net
      - hv10
      - hv60
    on_missing: status = "missing_high"
  
  optional:
    description: 缺失不影响核心分析
    fields:
      - gamma_wall_2
      - max_pain
      - major_oi_strikes
      - vanna_atm
      - put_skew_25
      - call_skew_25
      - spread_atm
      - pcr_ratio
      - smile_curvature
      - net_dex_sign
      - total_net_gex
    on_missing: status = "missing_optional"

# =============================================================================
# 数据质量计算
# =============================================================================
data_quality_calculation:
  formula: |
    score = 0
    for field in all_fields:
      if field.is_present:
        weight = priority_weights[field.priority]
        score += weight
    return score / max_possible_score * 100
  
  priority_weights:
    critical: 10
    high: 5
    optional: 2
  
  quality_levels:
    excellent:
      min_score: 90
      description: 所有关键字段完整
    good:
      min_score: 70
      description: 大部分字段完整
    acceptable:
      min_score: 50
      description: 核心字段完整，可继续分析
    poor:
      min_score: 0
      description: 缺失关键字段，建议补充

# =============================================================================
# 字段来源命令映射
# =============================================================================
source_commands:
  trigger:
    command: "!trigger {symbol}"
    fields:
      - vol_trigger
    output_parsing: "VOL TRIGGER / GEX Flip 行的数值"
  
  gexr:
    command: "!gexr {symbol} 15"
    fields:
      - gamma_wall
      - gamma_wall_2
      - call_wall
      - put_wall
      - max_pain
    output_parsing: "分别从 Gamma Wall, Call Wall, Put Wall, Max Pain 行提取"
  
  gexn:
    command: "!gexn {symbol}"
    fields:
      - total_net_gex
    output_parsing: "Total NET GEX 数值"
  
  surface_ivmid:
    command: "!surface {symbol} ivmid"
    fields:
      - iv_atm
      - iv_front
      - iv_back
    output_parsing: "ATM 列的近月和远月 IV"
  
  vexn:
    command: "!vexn {symbol} 15 190 *"
    fields:
      - vex_net
    output_parsing: "NET VEX 数值"
  
  skew:
    command: "!skew {symbol} ivmid atm 30"
    fields:
      - put_skew_25
      - call_skew_25
    output_parsing: "25D Put 和 25D Call 与 ATM 的差值"
  
  spread:
    command: "!surface {symbol} spread atm"
    fields:
      - spread_atm
    output_parsing: "ATM 行的 Spread 百分比"
  
  vanna:
    command: "!vanna {symbol}"
    fields:
      - vanna_atm
    output_parsing: "ATM 位置的 Vanna 值"
