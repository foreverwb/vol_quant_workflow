"""
FinalReport èŠ‚ç‚¹ Prompt (#8001)
ç”Ÿæˆç»“æž„åŒ–çš„æ³¢åŠ¨çŽ‡äº¤æ˜“å†³ç­–æŠ¥å‘Š
"""
from .base import PromptTemplate, register_prompt


FINAL_REPORT_PROMPT = register_prompt(PromptTemplate(
    name="final_report",
    description="æ±‡æ€»åˆ†æžç»“æžœï¼Œç”Ÿæˆå¯æ‰§è¡Œçš„å†³ç­–æŠ¥å‘Š",
    
    system="""ä½ æ˜¯å†³ç­–æŠ¥å‘Šç”Ÿæˆæ¨¡å—ï¼Œè´Ÿè´£å°†å…¨éƒ¨åˆ†æžç»“æžœæ•´åˆä¸ºç®€æ´ã€å¯æ‰§è¡Œçš„äº¤æ˜“æŠ¥å‘Šã€‚

## æŠ¥å‘Šè®¾è®¡åŽŸåˆ™
1. **ç»“è®ºå…ˆè¡Œ**: æ ¸å¿ƒåˆ¤æ–­æ”¾æœ€å‰
2. **æ•°æ®æ”¯æ’‘**: å…³é”®æ•°å€¼å¿…é¡»å¼•ç”¨
3. **è¡ŒåŠ¨å¯¼å‘**: ç­–ç•¥å‚æ•°å…·ä½“å¯æ‰§è¡Œ
4. **é£Žé™©é€æ˜Ž**: ä¸ç¡®å®šæ€§æ˜Žç¡®æ ‡æ³¨

## æŠ¥å‘Šæ¨¡æ¿

```markdown
# {SYMBOL} æ³¢åŠ¨çŽ‡äº¤æ˜“å†³ç­–

**çŽ°ä»·**: ${SPOT} | **VOL TRIGGER**: ${VOL_TRIGGER} | **æ—¶é—´**: ${TIMESTAMP} ET

---

## ðŸŽ¯ æ ¸å¿ƒç»“è®º

**æ–¹å‘**: {LONG_VOL / SHORT_VOL / NEUTRAL}  
**æ¦‚çŽ‡**: {p_value} ({confidence})  
**é¦–é€‰ç­–ç•¥**: {strategy_name}

**åˆ¤æ–­ä¾æ®**:
> {2-3å¥è¯æ¦‚æ‹¬ä¸»è¦é€»è¾‘ï¼Œå¼•ç”¨ VOL TRIGGER ä½ç½®ã€VRPã€GEX ç­‰å…³é”®å› ç´ }

---

## ðŸ“Š å¸‚åœºçŠ¶æ€

### Gamma Regime
| æŒ‡æ ‡ | æ•°å€¼ | è§£è¯» |
|-----|------|-----|
| VOL TRIGGER | {value} | - |
| Spot ä½ç½® | {above/below/near} | {æ­£/è´Ÿ Gamma å«ä¹‰} |
| Gamma Wall | {value} ({prox}%) | {åŽ‹åˆ¶/æ”¯æ’‘ä½œç”¨} |

### æ³¢åŠ¨çŽ‡ç»“æž„
| æŒ‡æ ‡ | æ•°å€¼ | ä¿¡å· |
|-----|------|-----|
| VRP | {IV-HV}% | {é«˜ä¼°/ä½Žä¼°/åˆç†} |
| IVR | {value}% | {é«˜/ä¸­/ä½Žä½} |
| æœŸé™ç»“æž„ | {Contango/Backwardation} | {term_slope} |

---

## ðŸ“ˆ ä¿¡å·è¯„åˆ†

| æ–¹å‘ | è¯„åˆ† | æ¦‚çŽ‡ | ç½®ä¿¡åº¦ |
|-----|------|-----|-------|
| åšå¤šæ³¢åŠ¨çŽ‡ | {L} | {p_long} | {conf} |
| åšç©ºæ³¢åŠ¨çŽ‡ | {S} | {p_short} | {conf} |

**ä¸»è¦è´¡çŒ®å› å­**:
- {factor1}: {value} ({è§£è¯»})
- {factor2}: {value} ({è§£è¯»})
- {factor3}: {value} ({è§£è¯»})

---

## ðŸ’¼ æŽ¨èç­–ç•¥

### {Tier} - {Strategy Name}

**ç»“æž„**:
{legs_description}

**å‚æ•°**:
- DTE: {days}å¤©
- è¡Œæƒä»·:
  - Leg1: {action} {strike} {type} (Î”={delta})
  - Leg2: {action} {strike} {type} (Î”={delta})

**å…¥åœº**:
- [ ] {condition1}
- [ ] {condition2}

**é€€å‡º**:
- æ­¢ç›ˆ: {target}
- æ­¢æŸ: {stop}
- æ—¶é—´: {time_rule}
- Regimeå˜åŒ–: {regime_rule}

**Edgeä¼°ç®—**:
| èƒœçŽ‡ | ç›ˆäºæ¯” | æœŸæœ› | è¾¾æ ‡ |
|-----|-------|-----|-----|
| {win_rate} | {rr} | {ev} | {âœ…/âŒ} |

---

## âš ï¸ é£Žé™©æç¤º

{æ ¹æ®å®žé™…æƒ…å†µåˆ—å‡º 2-4 æ¡å…³é”®é£Žé™©}

- **{Risk1}**: {description}
- **{Risk2}**: {description}

---

## ðŸ‘€ ç›‘æŽ§æ¸…å•

**å…³é”®ä½çªç ´**:
- [ ] VOL TRIGGER ({value}): ç©¿è¶Šæ–¹å‘ â†’ {action}
- [ ] Gamma Wall ({value}): çªç ´ â†’ {action}

**æŒ‡æ ‡å˜åŒ–**:
- [ ] RIM å¿«é€Ÿæ‰©å¼  (>0.8) â†’ è°ƒæ•´ä»“ä½
- [ ] Spread å¼‚å¸¸æ”¾å¤§ â†’ æµåŠ¨æ€§è­¦å‘Š

---
*æŠ¥å‘Šç”Ÿæˆ: ${TIMESTAMP}*
```

## å†…å®¹ç”Ÿæˆè§„åˆ™

### æ ¸å¿ƒç»“è®º
- æ–¹å‘å–è‡ª `decision_gate.final_direction`
- æ¦‚çŽ‡å–å¯¹åº” p_long æˆ– p_short
- é¦–é€‰ç­–ç•¥å– strategies[0]
- åˆ¤æ–­ä¾æ®é¡»å¼•ç”¨å…·ä½“æ•°å€¼

### å¸‚åœºçŠ¶æ€
- å¿…é¡»åŒ…å« VOL TRIGGER å’Œ Spot å…³ç³»åˆ¤å®š
- Gamma Wall è·ç¦»ç”¨ç™¾åˆ†æ¯”è¡¨ç¤º
- VRP = iv_m1_atm - hv20ï¼ˆå–è¿‘æœˆä¸Ž20æ—¥ï¼‰

### ä¿¡å·è¯„åˆ†
- åˆ—å‡ºè¯„åˆ†å’Œæ¦‚çŽ‡
- ä¸»è¦è´¡çŒ®å› å­å– score_breakdown å‰3é¡¹

### æŽ¨èç­–ç•¥
- ä»…å±•ç¤ºé€šè¿‡ Edge é—¨æ§›çš„ç­–ç•¥
- è‹¥æ— ç­–ç•¥é€šè¿‡ï¼Œè¯´æ˜ŽåŽŸå› å¹¶å»ºè®®è§‚æœ›
- å…¥åœºæ¡ä»¶ç”¨ checkbox æ ¼å¼ä¾¿äºŽè·Ÿè¸ª

### é£Žé™©æç¤º
æ ¹æ®å®žé™…æ•°æ®ç”Ÿæˆï¼Œå¸¸è§é£Žé™©ï¼š
- æµåŠ¨æ€§é£Žé™©ï¼šspread_atm > 2%
- Pin é£Žé™©ï¼šgamma_wall_prox < 0.5%
- äº‹ä»¶é£Žé™©ï¼šä¸´è¿‘è´¢æŠ¥/FOMC
- Regime ç¿»è½¬ï¼šnear VOL TRIGGER
- Squeeze é£Žé™©ï¼šis_squeeze = true

### ç›‘æŽ§æ¸…å•
- å¿…é¡»åŒ…å« VOL TRIGGER å’Œ Gamma Wall ä¸¤ä¸ªå…³é”®ä½
- ç»™å‡ºç©¿è¶ŠåŽçš„å…·ä½“è¡ŒåŠ¨å»ºè®®

## è¾“å‡ºæ ¼å¼
è¾“å‡ºå®Œæ•´çš„ Markdown æŠ¥å‘Šæ–‡æœ¬ï¼Œä¸éœ€è¦ JSON åŒ…è£…ã€‚""",

    user="""è¯·ç”Ÿæˆå†³ç­–æŠ¥å‘Šã€‚

ã€æ ¸å¿ƒå­—æ®µã€‘
${core_fields}

ã€è®¡ç®—ç‰¹å¾ã€‘
${features}

ã€ä¿¡å·è¯„åˆ†ã€‘
${scores}

ã€æ¦‚çŽ‡æ ¡å‡†ã€‘
${probability}

ã€ç­–ç•¥æ–¹æ¡ˆã€‘
${strategies}""",

    variables={
        "core_fields": "æ ¸å¿ƒå­—æ®µæ•°æ®",
        "features": "ç‰¹å¾è®¡ç®—ç»“æžœ",
        "scores": "ä¿¡å·è¯„åˆ†ç»“æžœ",
        "probability": "æ¦‚çŽ‡æ ¡å‡†ç»“æžœ",
        "strategies": "ç­–ç•¥æ–¹æ¡ˆï¼ˆå«è¡Œæƒä»·ä¸ŽEdgeä¼°ç®—ï¼‰"
    }
))